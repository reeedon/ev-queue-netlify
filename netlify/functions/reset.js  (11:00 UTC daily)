
// netlify/functions/reset.js
// Scheduled daily reset of queue and charger occupancy.
// Runs at 11:00 UTC (â‰ˆ 6:00 AM EST; switch to 10:00 UTC during EDT for exact 6:00 AM ET).

export const config = { schedule: "0 11 * * *" };

export default async (req) => {
  try {
    const BASE = process.env.PUBLIC_BASE_URL;      // e.g., https://your-site.netlify.app
    const KEY  = process.env.INTERNAL_KEY || "";   // optional shared secret
    if (!BASE) return new Response('Missing PUBLIC_BASE_URL', { status: 500 });

    const readRes = await fetch(`${BASE}/.netlify/functions/state`, { headers: KEY ? { 'x-key': KEY } : {} });
    if (!readRes.ok) return new Response(`Read failed: ${readRes.status}`, { status: 500 });
    const state = await readRes.json();

    state.queue = [];
    if (Array.isArray(state.spots)) state.spots = state.spots.map(s => ({ ...s, userId: null }));
    state.lastReset = new Date().toISOString();

    const writeRes = await fetch(`${BASE}/.netlify/functions/state`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json', ...(KEY ? { 'x-key': KEY } : {}) },
      body: JSON.stringify({ action: 'writeAll', payload: state })
    });
    if (!writeRes.ok) return new Response(`Write failed: ${writeRes.status}`, { status: 500 });

    return new Response('Daily reset complete', { status: 200 });
  } catch (err) {
    return new Response(`Error: ${err.message}`, { status:    return new Response(`Error: ${err.message}`, { status: 500 });
  }
