
// netlify/functions/reset.js
// CommonJS handler; schedule is configured in netlify.toml.

exports.handler = async function (event, context) {
  try {
    const BASE = process.env.PUBLIC_BASE_URL;      // e.g., https://unrivaled-druid-efd596.netlify.app
    const KEY  = process.env.INTERNAL_KEY || "";   // optional shared secret
    if (!BASE) {
      return { statusCode: 500, body: "Missing PUBLIC_BASE_URL" };
    }

    // Read current state
    const readRes = await fetch(`${BASE}/.netlify/functions/state`, {
      headers: KEY ? { 'x-key': KEY } : {}
    });
    if (!readRes.ok) {
      return { statusCode: 500, body: `Read failed: ${readRes.status}` };
    }
    const state = await readRes.json();

    // Reset queue + free all spots
    state.queue = [];
    if (Array.isArray(state.spots)) {
      state.spots = state.spots.map(s => ({ ...s, userId: null }));
    }
    state.lastReset = new Date().toISOString();

    // Write back
    const writeRes = await fetch(`${BASE}/.netlify/functions/state`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(KEY ? { 'x-key': KEY } : {})
      },
      body: JSON.stringify({ action: 'writeAll', payload: state })
    });
    if (!writeRes.ok) {
      return { statusCode: 500, body: `Write failed: ${writeRes.status}` };
    }

    return {
      statusCode: 200,
      body: "Daily reset complete"
    };
  } catch (err) {
       return { statusCode: 500, body: `Error: ${err.message}` };
  }

