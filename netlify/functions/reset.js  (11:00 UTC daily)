
// netlify/functions/reset.js
// CommonJS version (no `export`) so it runs in Netlify's Node runtime without ESM.
// The schedule will be set in netlify.toml (see step 2).

exports.handler = async function (event, context) {
  try {
    const BASE = process.env.PUBLIC_BASE_URL;      // e.g., https://unrivaled-druid-efd596.netlify.app
    const KEY  = process.env.INTERNAL_KEY || "";   // optional shared secret
    if (!BASE) return new Response('Missing PUBLIC_BASE_URL', { status: 500 });

    // Read current state
    const readRes = await fetch(`${BASE}/.netlify/functions/state`, {
      headers: KEY ? { 'x-key': KEY } : {}
    });
    if (!readRes.ok) return new Response(`Read failed: ${readRes.status}`, { status: 500 });
    const state = await readRes.json();

    // Reset queue + free all spots
    state.queue = [];
    if (Array.isArray(state.spots)) {
      state.spots = state.spots.map(s => ({ ...s, userId: null }));
    }
    state.lastReset = new Date().toISOString();

    // Write back
    const writeRes = await fetch(`${BASE}/.netlify/functions/state`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(KEY ? { 'x-key': KEY } : {})
      },
      body: JSON.stringify({ action: 'writeAll', payload: state })
    });
    if (!writeRes.ok) return new Response(`Write failed: ${writeRes.status}`, { status: 500 });

    return new Response('Daily reset complete', { status: 200 });
  } catch (err) {
    return new Response(`Error: ${err.message}`, { status: 500 });
  }
};
